<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TFT Widget</title>
    <style>
        @font-face {
            font-family: 'Helvetica Neue';
            src: url('../../font/helvetica-neue-5/HelveticaNeueBlackItalic.otf') format('opentype');
            font-style: italic;
            font-weight: 900;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #00000000;
            color: white;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        .background-image {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            width: auto;
            height: 100%;
            display: block;
            max-width: none;
        }

        .text-overlay {
            position: absolute;
            top: 50%;
            left: 50px;
            transform: translateY(-50%) scaleY(1.2) scaleX(0.85);
            z-index: 2;
            font-family: 'Helvetica Neue', sans-serif;
            font-style: italic;
            font-weight: 900;
            color: black;
            font-size: 100px;
            white-space: nowrap;
        }

        .points-container {
            position: absolute;
            top: 50%;
            left: 50px;
            transform: translateY(-50%) scaleY(1.2) scaleX(0.85);
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 20px;
            padding-left: 550px;
        }

        .separator {
            height: 50px;
            width: 30px;
            display: inline-block;
        }

        .points-text {
            font-family: 'Helvetica Neue', sans-serif;
            font-style: italic;
            font-weight: 900;
            color: black;
            font-size: 60px;
        }

        .rankings {
            font-family: 'Helvetica Neue', sans-serif;
            font-weight: 900;
            color: black;
            font-size: 75px;
        }
    </style>
</head>
<body>
    <img src="image/background.png" alt="Background" class="background-image">
    <div class="text-overlay">ENZOSX</div>
    <div class="points-container">
        <img src="image/separator.png" alt="separator" class="separator">
        <span class="points-text" id="points"></span>
        <span class="rankings" id="rankings"></span>
    </div>

    <script>
        // List of authorized users who can update the widget
        const authorizedUsers = [
            'sc0rpio74890',
            // Add more authorized usernames here (lowercase)
        ];

        // Connect to Twitch IRC via WebSocket
        function connectToTwitchChat() {
            const socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');

            socket.onopen = () => {
                console.log('✅ Connected to Twitch IRC');
                // Anonymous connection with tags support
                socket.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
                socket.send('PASS SCHMOOPIIE');
                socket.send('NICK justinfan12345');
                socket.send('JOIN #sc0rpio74890');
            };

            socket.onmessage = (event) => {
                const rawMessage = event.data;

                // Respond to PING
                if (rawMessage.startsWith('PING')) {
                    socket.send('PONG :tmi.twitch.tv');
                    return;
                }

                // Parse chat messages
                if (rawMessage.includes('PRIVMSG')) {
                    parseMessage(rawMessage);
                }
            };

            socket.onerror = (error) => {
                console.error('❌ WebSocket error:', error);
            };

            socket.onclose = () => {
                console.log('🔌 Connection closed, reconnecting in 5s...');
                setTimeout(connectToTwitchChat, 5000);
            };
        }

        function parseMessage(rawMessage) {
            try {
                // Extract username
                const usernameMatch = rawMessage.match(/:([^!]+)!/);
                if (!usernameMatch) return;
                const username = usernameMatch[1].toLowerCase();

                // Extract badges
                const badgesMatch = rawMessage.match(/badges=([^;]*)/);
                const badges = badgesMatch ? badgesMatch[1] : '';

                const isMod = badges.includes('moderator');
                const isBroadcaster = badges.includes('broadcaster');

                // Check authorization
                const isAuthorized = isBroadcaster || isMod || authorizedUsers.includes(username);
                if (!isAuthorized) return;

                // Extract message text
                const messageMatch = rawMessage.match(/PRIVMSG #\w+ :(.+)/);
                if (!messageMatch) return;
                const messageText = messageMatch[1].trim();

                // Check for !enzosx command
                if (messageText.toLowerCase().startsWith('!enzosx ')) {
                    const args = messageText.slice(8).trim();
                    const parts = args.split(' ');

                    if (parts.length < 2) return;

                    const points = parts[0];
                    const rankings = parts.slice(1).join(' ');

                    // Validate points format
                    if (!points.toLowerCase().endsWith('pts')) return;

                    // Update display
                    document.getElementById('points').textContent = points + ' - ';
                    document.getElementById('rankings').textContent = rankings;

                    console.log(`✅ Updated by ${username}: ${points} ${rankings}`);
                }
            } catch (error) {
                console.error('❌ Error parsing message:', error);
            }
        }

        // Start connection when page loads
        window.addEventListener('load', () => {
            connectToTwitchChat();
            console.log('🚀 Widget initialized - waiting for !enzosx commands');
        });
    </script>
</body>
</html>
